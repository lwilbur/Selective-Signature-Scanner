#!/usr/bin/env python3
import subprocess

# wget --post-data "query=get_file&sha256_hash=094fd325049b8a9cf6d3e5ef2a6d4cc6a567d7d49c35f8bb8dd9e3c6acf3d78d" https://mb-api.abuse.ch/api/v1/

# List of Yara rules to query
yara_rules = ["SharedStrings",
              "Cobalt_functions", 
              "DridexV4",
              "Win32_Trojan_Emotet", 
              "SUSP_Excel4Macro_AutoOpen", 
              "unixredflags3", 
              "CAP_HookExKeylogger", 
              "win_agent_tesla_w1", 
              "MALW_emotet", 
              "shellcode"]


def main():
    # Create folder to hold all the rule folders
    main_folder = "malware_samples"
    subprocess.run(["mkdir", main_folder])

    # Each rule
    for rule in yara_rules:
        # Create a folder for the rule
        dir_path = f"{main_folder}/{rule}"
        subprocess.run(["mkdir", dir_path])

        # Fetch list of 50 malware hashes matched by YARA rule
        hash_list_dest = f"-O{dir_path}/hashes.txt"
        query = f"query=get_yarainfo&yara_rule={rule}&limit=5" # TODO: 50
        site = "https://mb-api.abuse.ch/api/v1/"
        subprocess.run(["wget", hash_list_dest, "--post-data", query, site])


if __name__== "__main__":
    main()

